<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Log - Registro Fotográfico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div id="loader"></div>

    <!-- Pantallas de auth -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center fade-in hidden">
        <div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">Bienvenido a Film Log</h2>
            <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="auth-tabs">
                    <li class="mr-2"><button class="inline-block p-4 border-b-2 rounded-t-lg" data-tab="login">Iniciar Sesión</button></li>
                    <li><button class="inline-block p-4 border-b-2 rounded-t-lg" data-tab="register">Registrarse</button></li>
                </ul>
            </div>
            <div id="login-form-container">
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email</label><input type="email" id="login-email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required></div>
                    <div class="mb-6"><label for="login-password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Contraseña</label><input type="password" id="login-password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required></div>
                    <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 rounded-lg text-sm px-5 py-2.5">Iniciar Sesión</button>
                </form>
            </div>
            <div id="register-form-container" class="hidden">
                 <form id="register-form">
                    <div class="mb-4"><label for="register-email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email</label><input type="email" id="register-email" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700"></div>
                    <div class="mb-4"><label for="register-password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Contraseña (mín. 6 caracteres)</label><input type="password" id="register-password" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700"></div>
                    <div class="mb-6"><label for="invite-code" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Código de Invitación</label><input type="text" id="invite-code" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700"></div>
                    <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 rounded-lg text-sm px-5 py-2.5">Crear Cuenta</button>
                </form>
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
            <div class="relative flex py-5 items-center"><div class="flex-grow border-t"></div><span class="flex-shrink mx-4">O</span><div class="flex-grow border-t"></div></div>
            <button id="google-signin-btn" class="w-full bg-white dark:bg-gray-700 border border-gray-300 rounded-lg px-5 py-2.5">Continuar con Google</button>
        </div>
    </div>

    <!-- Modal Google Invite -->
    <div id="google-invite-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Registro casi completo</h3>
            <p class="text-sm mb-4">Introduce tu código de invitación válido para finalizar.</p>
            <form id="google-invite-form">
                <label for="google-invite-code" class="block mb-2 text-sm">Código de Invitación</label>
                <input type="text" id="google-invite-code" required class="bg-gray-50 border border-gray-300 rounded-lg block w-full p-2.5">
                <p id="google-invite-error" class="text-red-500 text-sm mt-2"></p>
                <button type="submit" class="w-full mt-4 text-white bg-blue-600 hover:bg-blue-700 rounded-lg text-sm px-5 py-2.5">Verificar y Continuar</button>
            </form>
            <button id="cancel-google-invite-btn" class="w-full mt-2 text-sm text-gray-500 hover:underline">Cancelar registro</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, getAdditionalUserInfo, deleteUser } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { /* tus credenciales */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let pendingInviteDoc = null;
        let pendingGoogleUser = null;

        // Registro email
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const inviteCode = inviteCodeInput.value.trim();
            authError.textContent = '';
            try {
                const q = query(collection(db, "invitations"), where("code", "==", inviteCode));
                const qs = await getDocs(q);
                if (qs.empty) throw new Error("El código no existe");
                const inviteDoc = qs.docs[0];
                if (inviteDoc.data().isUsed) throw new Error("Código ya usado");
                pendingInviteDoc = inviteDoc;
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (err) { authError.textContent = err.message; }
        });

        // Google SignIn
        googleSigninBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const info = getAdditionalUserInfo(result);
                if (info.isNewUser) {
                    pendingGoogleUser = result.user;
                    document.getElementById('google-invite-modal').classList.remove('hidden');
                }
            } catch (err) { console.error(err); }
        });

        googleInviteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('google-invite-code').value.trim();
            const errorEl = document.getElementById('google-invite-error');
            errorEl.textContent = '';
            try {
                const q = query(collection(db, "invitations"), where("code", "==", code));
                const qs = await getDocs(q);
                if (qs.empty || qs.docs[0].data().isUsed) {
                    errorEl.textContent = 'Código no válido o ya usado';
                } else {
                    pendingInviteDoc = qs.docs[0];
                    document.getElementById('google-invite-modal').classList.add('hidden');
                }
            } catch (err) { errorEl.textContent = 'Error al verificar el código'; }
        });

        cancelGoogleInviteBtn.addEventListener('click', async () => {
            if (pendingGoogleUser) {
                await deleteUser(pendingGoogleUser);
                pendingGoogleUser = null;
            }
            document.getElementById('google-invite-modal').classList.add('hidden');
        });

        // onAuthStateChanged para aplicar invitaciones
        onAuthStateChanged(auth, async (user) => {
            if (user && pendingInviteDoc) {
                try {
                    await updateDoc(doc(db, "invitations", pendingInviteDoc.id), {
                        isUsed: true,
                        usedBy: user.uid,
                        usedAt: serverTimestamp()
                    });
                    pendingInviteDoc = null;
                } catch (err) { console.error("Error al aplicar invitación", err); }
            }
        });
    </script>
</body>
</html>
